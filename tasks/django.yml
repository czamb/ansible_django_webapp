---

- name: chown webapp files to deploy user
  sudo: yes
  file: path={{ webapp_dir }} owner={{ user }} recurse=yes

- name: django syncdb
  sudo_user: "{{ user }}"
  sudo: yes
  django_manage: >
                 command=syncdb
                 app_path={{ django_dir }}
                 virtualenv={{ virtualenv_dir }}
                 settings={{ django_settings }}
  ignore_errors: yes
  environment:
    SECRET_KEY: "{{ SECRET_KEY }}"
    DJANGO_SECRET_KEY: "{{ SECRET_KEY }}"
    DJANGO_SETTINGS_MODULE: "{{ django_settings }}"
    DJANGO_AWS_ACCESS_KEY_ID: "{{ DJANGO_AWS_ACCESS_KEY_ID }}"
    DJANGO_AWS_SECRET_ACCESS_KEY: "{{ DJANGO_AWS_SECRET_ACCESS_KEY }}"
    DJANGO_AWS_STORAGE_BUCKET_NAME: "{{ DJANGO_AWS_STORAGE_BUCKET_NAME }}"
    DATABASE_URL: "postgres://localhost/{{ database_name }}"
    SENDGRID_USERNAME: "{{ SENDGRID_USERNAME }}"
    SENDGRID_PASSWORD: "{{ SENDGRID_PASSWORD }}"
    DJANGO_LOGFILE_PATH: "{{ DJANGO_LOGFILE_PATH }}"

- name: django migrate
  sudo_user: "{{ user }}"
  sudo: yes
  django_manage: >
                 command=migrate
                 app_path={{ django_dir }}
                 virtualenv={{ virtualenv_dir }}
                 settings={{ django_settings }}
  ignore_errors: yes
  environment:
    SECRET_KEY: "{{ SECRET_KEY }}"
    DJANGO_SECRET_KEY: "{{ SECRET_KEY }}"
    DJANGO_SETTINGS_MODULE: "{{ django_settings }}"
    DJANGO_AWS_ACCESS_KEY_ID: "{{ DJANGO_AWS_ACCESS_KEY_ID }}"
    DJANGO_AWS_SECRET_ACCESS_KEY: "{{ DJANGO_AWS_SECRET_ACCESS_KEY }}"
    DJANGO_AWS_STORAGE_BUCKET_NAME: "{{ DJANGO_AWS_STORAGE_BUCKET_NAME }}"
    DATABASE_URL: "postgres://localhost/{{ database_name }}"
    SENDGRID_USERNAME: "{{ SENDGRID_USERNAME }}"
    SENDGRID_PASSWORD: "{{ SENDGRID_PASSWORD }}"
    DJANGO_LOGFILE_PATH: "{{ DJANGO_LOGFILE_PATH }}"

- name: django collectstatic
  sudo_user: "{{ user }}"
  sudo: yes
  django_manage: >
                 command=collectstatic
                 app_path={{ django_dir }}
                 virtualenv={{ virtualenv_dir }}
                 settings={{ django_settings }}
  environment:
    SECRET_KEY: "{{ SECRET_KEY }}"
    DJANGO_SECRET_KEY: "{{ SECRET_KEY }}"
    DJANGO_SETTINGS_MODULE: "{{ django_settings }}"
    DJANGO_AWS_ACCESS_KEY_ID: "{{ DJANGO_AWS_ACCESS_KEY_ID }}"
    DJANGO_AWS_SECRET_ACCESS_KEY: "{{ DJANGO_AWS_SECRET_ACCESS_KEY }}"
    DJANGO_AWS_STORAGE_BUCKET_NAME: "{{ DJANGO_AWS_STORAGE_BUCKET_NAME }}"
    DATABASE_URL: "postgres://localhost/{{ database_name }}"
    SENDGRID_USERNAME: "{{ SENDGRID_USERNAME }}"
    SENDGRID_PASSWORD: "{{ SENDGRID_PASSWORD }}"
    DJANGO_LOGFILE_PATH: "{{ DJANGO_LOGFILE_PATH }}"
